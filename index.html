<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlowMatrix - Calendar Edition</title>

    <!-- æ ¸å¿ƒä¾èµ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/locale/zh-cn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/plugin/isBetween.min.js"></script>

    <!-- å­—ä½“ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
      :root {
        --font-main: "Outfit", sans-serif;
        --font-mono: "JetBrains Mono", monospace;
      }
      body {
        font-family: var(--font-main);
        background-color: #f0f4f8;
        color: #334155;
      }

      /* ç»ç’ƒæ‹Ÿæ€ */
      .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .gradient-bg {
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      }

      /* è±¡é™è‰²è°ƒ */
      .q1-bg {
        background: linear-gradient(145deg, #fff1f2 0%, #ffe4e6 100%);
        border-color: #fecdd3;
      }
      .q2-bg {
        background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #bfdbfe;
      }
      .q3-bg {
        background: linear-gradient(145deg, #fffbeb 0%, #fef3c7 100%);
        border-color: #fde68a;
      }
      .q4-bg {
        background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
        border-color: #e2e8f0;
      }

      /* åŠ¨ç”» */
      @keyframes breathe {
        0%,
        100% {
          box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
          transform: scale(1.005);
        }
      }
      .focus-active {
        animation: breathe 3s ease-in-out infinite;
        border: 2px solid #818cf8;
      }

      /* æ»šåŠ¨æ¡ */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* æ ‡ç­¾ */
      .tag-badge {
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* ç»Ÿè®¡å¡ç‰‡æ¸å˜ */
      .stat-card-today {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .stat-card-week {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }

      /* æ—¥å†æ ·å¼ */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 0.9rem;
      }
      .calendar-day:hover {
        background-color: #f1f5f9;
      }
      .calendar-day.is-selected {
        background-color: #1e293b;
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .calendar-day.is-today {
        border: 2px solid #6366f1;
        color: #6366f1;
        font-weight: bold;
      }
      .calendar-day.is-today.is-selected {
        color: white;
        border-color: #1e293b;
      }
      .calendar-day.other-month {
        opacity: 0.3;
      }
      .has-task-dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: #10b981;
        margin-top: 2px;
      }
      .is-selected .has-task-dot {
        background-color: #4ade80;
      }
    </style>
  </head>
  <body
    class="h-screen flex flex-col overflow-hidden bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')] bg-cover bg-center"
  >
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-white/80 backdrop-blur-md z-0"></div>

    <div
      id="app"
      class="relative z-10 h-full flex flex-col max-w-7xl mx-auto w-full shadow-2xl bg-white/40 sm:border-x border-white/50"
    >
      <!-- ================= HEADER ================= -->
      <header
        class="px-6 py-4 flex justify-between items-center bg-white/60 border-b border-white/50 backdrop-blur-sm"
      >
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-xl bg-slate-800 text-white flex items-center justify-center font-bold text-xl shadow-lg"
          >
            F
          </div>
          <div class="flex flex-col">
            <h1
              class="font-bold text-slate-800 text-lg leading-none tracking-tight"
            >
              FlowMatrix
            </h1>
            <span
              class="text-[10px] text-slate-500 font-medium uppercase tracking-widest mt-0.5"
              >Pro Dashboard</span
            >
          </div>
        </div>

        <!-- Controls -->
        <div class="flex items-center gap-6">
          <!-- Clock -->
          <div class="hidden sm:flex flex-col items-end mr-2">
            <span
              class="font-mono text-2xl font-bold text-slate-700 leading-none tracking-tight"
              >{{ timeDisplay.time }}</span
            >
            <span
              class="text-xs font-medium text-slate-400 uppercase tracking-wide"
              >{{ timeDisplay.date }} Â· {{ timeDisplay.day }}</span
            >
          </div>

          <!-- Stats Button -->
          <button
            @click="showStats = true"
            class="group relative p-2 rounded-lg hover:bg-white hover:shadow-md transition-all text-slate-500 hover:text-indigo-600"
            title="æŸ¥çœ‹ç»Ÿè®¡"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
            <span
              v-if="todayStats.count > 0"
              class="absolute top-1 right-1 w-2 h-2 bg-indigo-500 rounded-full ring-2 ring-white"
            ></span>
          </button>

          <!-- Calendar Button -->
          <button
            @click="openCalendar"
            class="p-2 rounded-lg hover:bg-white hover:shadow-md transition-all text-slate-500 hover:text-indigo-600"
            title="æ—¥å†è®°å½•"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
          </button>

          <!-- Status Dot -->
          <div
            class="w-2.5 h-2.5 rounded-full ring-2 ring-white/50"
            :class="loading ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'"
          ></div>
        </div>
      </header>

      <!-- ================= MAIN CONTENT ================= -->
      <main
        class="flex-1 flex flex-col overflow-hidden p-4 sm:p-6 gap-6 relative"
      >
        <!-- Focus Stage -->
        <section
          class="flex-none transition-all duration-500 ease-in-out"
          :class="basketTask ? 'min-h-[220px]' : 'h-28'"
        >
          <div
            class="w-full h-full rounded-3xl glass-panel shadow-lg overflow-hidden relative flex flex-col items-center justify-center p-6 transition-all"
            :class="basketTask ? 'focus-active bg-white/90' : 'bg-white/40 border-dashed border-2 border-indigo-200/50 hover:border-indigo-300'"
          >
            <div
              v-if="basketTask"
              class="w-full max-w-4xl flex flex-col items-center text-center z-10 animate-fade-in relative"
            >
              <div
                class="absolute top-[-10px] right-0 sm:right-auto flex gap-2"
              >
                <span
                  class="px-2 py-1 rounded text-[10px] font-bold tracking-wider text-white uppercase bg-indigo-500 shadow-sm"
                  >Focus Mode</span
                >
              </div>

              <div
                class="flex flex-col sm:flex-row items-center gap-4 sm:gap-12 w-full justify-center"
              >
                <div class="text-center">
                  <!-- å¤§å·è®¡æ—¶å™¨ -->
                  <div
                    class="font-mono text-5xl sm:text-7xl font-bold text-slate-800 tracking-tighter tabular-nums drop-shadow-sm"
                  >
                    {{ currentTimerDisplay }}
                  </div>
                  <div
                    class="text-xs font-bold text-indigo-400 uppercase tracking-widest mt-1"
                  >
                    Duration
                  </div>
                </div>

                <div class="flex-1 min-w-0 max-w-xl text-center sm:text-left">
                  <div
                    class="flex items-center justify-center sm:justify-start gap-2 mb-2"
                  >
                    <span
                      class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                      >Now Doing</span
                    >
                    <span
                      v-if="basketTask.tags"
                      v-for="tag in basketTask.tags.split(',')"
                      :key="tag"
                      class="text-[10px] px-1.5 py-0.5 bg-indigo-50 text-indigo-600 rounded border border-indigo-100 font-bold"
                      >#{{ tag.trim() }}</span
                    >
                  </div>
                  <h2
                    class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight mb-2 line-clamp-2"
                  >
                    {{ basketTask.title }}
                  </h2>
                  <p
                    v-if="basketTask.description"
                    class="text-sm text-slate-500 italic line-clamp-2"
                  >
                    "{{ basketTask.description }}"
                  </p>
                </div>
              </div>

              <div
                class="flex gap-3 mt-6 sm:mt-0 sm:absolute sm:bottom-0 sm:right-0"
              >
                <button
                  @click="completeTask(basketTask)"
                  class="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-700 shadow-lg shadow-slate-300 hover:-translate-y-0.5 transition-all active:scale-95 flex items-center gap-2 text-sm"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      d="M5 13l4 4L19 7"
                    ></path>
                  </svg>
                  å®Œæˆ
                </button>
                <button
                  @click="pauseTask(basketTask)"
                  class="bg-white text-slate-600 border border-slate-200 px-4 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition-all active:scale-95 text-sm"
                  title="æš‚åœ/æ”¾å›"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 9v6m4-6v6"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <div v-else class="flex items-center gap-4 text-slate-400">
              <div class="p-3 bg-white/50 rounded-full">
                <svg
                  class="w-6 h-6 text-indigo-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <div class="text-left">
                <h3 class="text-base font-bold text-slate-600">
                  ç­‰å¾…ä»»åŠ¡ä¸­...
                </h3>
                <p class="text-xs opacity-70">ç‚¹å‡»ä¸‹æ–¹ä»»åŠ¡ä»¥å¼€å§‹è®¡æ—¶</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Matrix -->
        <section
          class="flex-1 min-h-0 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 overflow-y-auto pr-1 pb-2"
        >
          <div
            v-for="q in quadrants"
            :key="q.id"
            class="flex flex-col rounded-2xl border shadow-sm h-full min-h-[200px]"
            :class="q.bgClass"
          >
            <div
              class="px-4 py-3 border-b border-black/5 flex justify-between items-center bg-white/40 backdrop-blur-sm rounded-t-2xl sticky top-0 z-10"
            >
              <div class="flex items-center gap-2">
                <span class="text-lg">{{ q.icon }}</span>
                <span class="font-bold text-slate-700 text-sm"
                  >{{ q.name }}</span
                >
              </div>
              <button
                @click="openAddModal(q.id)"
                class="w-6 h-6 hover:bg-white rounded flex items-center justify-center text-slate-400 hover:text-indigo-600 transition-colors"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
              </button>
            </div>
            <div class="flex-1 p-3 overflow-y-auto space-y-2">
              <div
                v-for="task in getTasksByQuadrant(q.id)"
                :key="task.id"
                @click="moveToBasket(task)"
                class="bg-white p-3 rounded-xl shadow-sm border border-black/5 cursor-pointer group hover:scale-[1.01] transition-transform relative"
              >
                <button
                  @click.stop="deleteTask(task.id)"
                  class="absolute top-2 right-2 p-1.5 rounded-md text-slate-300 hover:text-red-500 hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-all z-20"
                >
                  <svg
                    class="w-3.5 h-3.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    ></path>
                  </svg>
                </button>
                <div v-if="task.tags" class="flex flex-wrap gap-1 mb-1.5">
                  <span
                    v-for="tag in task.tags.split(',')"
                    :key="tag"
                    class="tag-badge bg-slate-100 text-slate-500 border border-slate-200"
                    >{{ tag.trim() }}</span
                  >
                </div>
                <div
                  class="font-medium text-slate-700 text-sm pr-6 leading-snug"
                >
                  {{ task.title }}
                </div>
                <div
                  class="mt-2 flex items-center justify-between text-xs text-slate-400 border-t border-slate-50 pt-2"
                >
                  <div class="flex items-center gap-2">
                    <span
                      v-if="task.duration_seconds > 0"
                      class="flex items-center gap-1 font-mono text-indigo-400 font-bold"
                    >
                      <svg
                        class="w-3 h-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      {{ formatDuration(task.duration_seconds) }}
                    </span>
                    <span v-if="task.description" title="æœ‰å¤‡æ³¨"
                      ><svg
                        class="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 6h16M4 12h16M4 18h7"
                        ></path></svg
                    ></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- ================= MODALS ================= -->

      <!-- æ—¥å† Modal (ä¿®æ­£å¸ƒå±€ç‰ˆ) -->
      <div
        v-if="showCalendar"
        class="fixed inset-0 z-[75] flex items-center justify-center p-4"
      >
        <div
          class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm"
          @click="showCalendar = false"
        ></div>
        <div
          class="bg-white rounded-3xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden flex flex-col max-h-[85vh] animate-fade-in"
        >
          <!-- Calendar Header: å¸ƒå±€å·²æ›´æ–° -->
          <div
            class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50"
          >
            <div>
              <h2 class="text-xl font-bold text-slate-800">æˆå°±æ—¥å†</h2>
              <p class="text-xs text-slate-500 font-medium">æŸ¥çœ‹è¿‡å¾€çš„è¾‰ç…Œ</p>
            </div>

            <div class="flex items-center gap-4">
              <!-- æœˆä»½åˆ‡æ¢å™¨ (åŠ äº†èƒŒæ™¯æ¡†ï¼Œé˜²æ­¢ä¸å…³é—­æŒ‰é’®å†²çª) -->
              <div
                class="flex items-center gap-2 bg-white px-2 py-1 rounded-lg border border-slate-200 shadow-sm"
              >
                <button
                  @click="changeMonth(-1)"
                  class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600 transition-colors"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 19l-7-7 7-7"
                    ></path>
                  </svg>
                </button>
                <span
                  class="text-sm font-bold text-slate-700 min-w-[6rem] text-center select-none"
                  >{{ calendarTitle }}</span
                >
                <button
                  @click="changeMonth(1)"
                  class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600 transition-colors"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </button>
              </div>

              <!-- ç«–åˆ†å‰²çº¿ -->
              <div class="h-6 w-px bg-slate-200 hidden sm:block"></div>

              <!-- å…³é—­æŒ‰é’® (å·²ç§»å…¥ Flex å¸ƒå±€) -->
              <button
                @click="showCalendar = false"
                class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded-full transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Calendar Grid -->
          <div class="p-6">
            <!-- Weekdays -->
            <div class="grid grid-cols-7 gap-4 mb-2 text-center">
              <div
                v-for="d in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']"
                class="text-xs font-bold text-slate-400"
              >
                {{ d }}
              </div>
            </div>
            <!-- Days -->
            <div class="calendar-grid">
              <div
                v-for="day in calendarDays"
                :key="day.dateStr"
                @click="selectDate(day)"
                class="calendar-day"
                :class="{
                                 'other-month': !day.isCurrentMonth,
                                 'is-today': day.isToday,
                                 'is-selected': day.isSelected
                             }"
              >
                <span>{{ day.dayNum }}</span>
                <div v-if="day.hasTask" class="has-task-dot"></div>
              </div>
            </div>
          </div>

          <!-- Day Details -->
          <div
            class="flex-1 bg-slate-50 border-t border-slate-100 p-6 overflow-y-auto"
          >
            <h3
              class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-indigo-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                ></path>
              </svg>
              {{ selectedDateFormatted }} çš„è®°å½•
            </h3>

            <div v-if="selectedDateTasks.length > 0" class="space-y-3">
              <div
                v-for="task in selectedDateTasks"
                :key="task.id"
                class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center group"
              >
                <div class="flex-1 min-w-0 pr-2">
                  <div
                    class="text-sm font-medium text-slate-700 truncate line-through decoration-slate-300"
                  >
                    {{ task.title }}
                  </div>
                  <div class="flex gap-2 mt-1">
                    <span
                      class="text-[10px] bg-green-50 text-green-600 px-1.5 py-0.5 rounded font-mono font-bold"
                      >{{ formatDuration(task.duration_seconds) }}</span
                    >
                    <span
                      v-if="task.quadrant"
                      class="text-[10px] bg-slate-100 text-slate-400 px-1.5 py-0.5 rounded"
                      >Q{{ task.quadrant }}</span
                    >
                  </div>
                </div>
                <button
                  @click="deleteTask(task.id)"
                  class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <div v-else class="text-center py-8 text-slate-400 text-sm italic">
              è¿™å¤©æ²¡æœ‰å®Œæˆä»»ä½•ä»»åŠ¡
            </div>
          </div>
        </div>
      </div>

      <!-- ç»Ÿè®¡é¢æ¿ Modal -->
      <div
        v-if="showStats"
        class="fixed inset-0 z-[70] flex items-center justify-center p-4"
      >
        <div
          class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm"
          @click="showStats = false"
        ></div>
        <div
          class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl relative z-10 overflow-hidden animate-fade-in"
        >
          <div
            class="p-6 sm:p-8 bg-slate-50 border-b border-slate-100 flex justify-between items-center"
          >
            <div>
              <h2 class="text-2xl font-bold text-slate-800">æ•°æ®æ´å¯Ÿ</h2>
              <p
                class="text-xs text-slate-500 font-medium uppercase tracking-wide"
              >
                Performance Overview
              </p>
            </div>
            <button
              @click="showStats = false"
              class="text-slate-400 hover:text-slate-600 p-2 bg-white rounded-full shadow-sm hover:shadow"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <div class="p-6 sm:p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="stat-card-today rounded-2xl p-6 text-white shadow-lg shadow-indigo-200 relative overflow-hidden group"
            >
              <div
                class="absolute top-0 right-0 p-4 opacity-20 transform group-hover:scale-110 transition-transform"
              >
                <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <h3
                class="text-indigo-100 font-bold uppercase tracking-wider text-xs mb-4"
              >
                Today's Focus
              </h3>
              <div class="flex items-baseline gap-2 mb-1">
                <span class="text-5xl font-mono font-bold"
                  >{{ formatHours(todayStats.duration) }}</span
                >
                <span class="text-sm font-medium opacity-80">å°æ—¶</span>
              </div>
              <div
                class="flex items-center gap-2 mt-4 text-sm font-medium bg-white/20 w-fit px-3 py-1 rounded-full backdrop-blur-sm"
              >
                <span>âœ… å®Œæˆ {{ todayStats.count }} ä¸ªä»»åŠ¡</span>
              </div>
            </div>
            <div
              class="stat-card-week rounded-2xl p-6 text-slate-800 shadow-lg shadow-sky-100 relative overflow-hidden group"
            >
              <div
                class="absolute top-0 right-0 p-4 opacity-10 transform group-hover:scale-110 transition-transform"
              >
                <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                  ></path>
                </svg>
              </div>
              <h3
                class="text-slate-500 font-bold uppercase tracking-wider text-xs mb-4"
              >
                This Week
              </h3>
              <div class="flex items-baseline gap-2 mb-1">
                <span class="text-5xl font-mono font-bold text-slate-800"
                  >{{ formatHours(weekStats.duration) }}</span
                >
                <span class="text-sm font-medium text-slate-500">å°æ—¶</span>
              </div>
              <div
                class="flex items-center gap-2 mt-4 text-sm font-medium bg-white/40 w-fit px-3 py-1 rounded-full backdrop-blur-sm text-slate-600"
              >
                <span>ğŸ”¥ å®Œæˆ {{ weekStats.count }} ä¸ªä»»åŠ¡</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Modal -->
      <div
        v-if="showModal"
        class="fixed inset-0 z-[80] flex items-center justify-center p-4"
      >
        <div
          class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"
          @click="showModal = false"
        ></div>
        <div
          class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden animate-fade-in"
        >
          <div
            class="h-1.5 w-full"
            :class="getQuadrantColor(newTask.quadrant)"
          ></div>
          <div class="p-6 sm:p-8">
            <h3 class="text-xl font-bold text-slate-800 mb-6">
              æ·»åŠ ä»»åŠ¡è‡³
              <span :class="getQuadrantTextColor(newTask.quadrant)"
                >{{ getQuadrantName(newTask.quadrant) }}</span
              >
            </h3>
            <div class="space-y-4">
              <div>
                <label
                  class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
                  >æ ‡é¢˜</label
                >
                <input
                  v-model="newTask.title"
                  @keyup.enter="addTask"
                  type="text"
                  placeholder="æ ¸å¿ƒç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ"
                  class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-slate-800 outline-none transition-all placeholder-slate-300"
                  autofocus
                />
              </div>
              <div>
                <label
                  class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
                  >å¤‡æ³¨</label
                >
                <textarea
                  v-model="newTask.description"
                  rows="2"
                  placeholder="ç»†èŠ‚æè¿°..."
                  class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-slate-800 outline-none resize-none"
                ></textarea>
              </div>
              <div>
                <label
                  class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
                  >æ ‡ç­¾</label
                >
                <input
                  v-model="newTask.tags"
                  type="text"
                  placeholder="Design, Urgent..."
                  class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-slate-800 outline-none"
                />
              </div>
              <div>
                <label
                  class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"
                  >æ›´æ”¹è±¡é™</label
                >
                <div class="flex gap-2">
                  <button
                    v-for="q in quadrants"
                    :key="q.id"
                    @click="newTask.quadrant = q.id"
                    class="flex-1 py-2 rounded-lg text-xs font-bold border transition-all"
                    :class="newTask.quadrant === q.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'"
                  >
                    Q{{ q.id }}
                  </button>
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-8">
              <button
                @click="showModal = false"
                class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl text-sm font-bold"
              >
                å–æ¶ˆ
              </button>
              <button
                @click="addTask"
                class="px-8 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-700 shadow-lg text-sm font-bold"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, onUnmounted } = Vue;
      dayjs.extend(dayjs_plugin_isBetween);
      dayjs.locale("zh-cn");

      // ===========================================
      // TODO: é…ç½® Supabase
      // ===========================================
      const SUPABASE_URL = "https://xmbdhsiopgklunsplimh.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_Z0q1-9gRfvRsl_U5W9oPmQ_aWePMBiF";
      // ===========================================

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      createApp({
        setup() {
          const tasks = ref([]);
          const loading = ref(false);
          const showModal = ref(false);
          const showStats = ref(false);
          const showCalendar = ref(false);
          const newTask = ref({
            title: "",
            description: "",
            tags: "",
            quadrant: 1,
          });
          const now = ref(dayjs());
          let timerInterval;

          // Calendar State
          const currentCalendarDate = ref(dayjs()); // Month navigator
          const selectedDate = ref(dayjs()); // Selected day for details

          const quadrants = [
            { id: 1, name: "é‡è¦ä¸”ç´§æ€¥", bgClass: "q1-bg", icon: "ğŸ”¥" },
            { id: 2, name: "é‡è¦ä¸ç´§æ€¥", bgClass: "q2-bg", icon: "ğŸš€" },
            { id: 3, name: "ç´§æ€¥ä¸é‡è¦", bgClass: "q3-bg", icon: "âš¡" },
            { id: 4, name: "ä¸æ€¥ä¸é‡è¦", bgClass: "q4-bg", icon: "â˜•" },
          ];

          onMounted(() => {
            fetchTasks();
            timerInterval = setInterval(() => {
              now.value = dayjs();
            }, 1000);
          });
          onUnmounted(() => clearInterval(timerInterval));

          const fetchTasks = async () => {
            loading.value = true;
            const { data } = await client
              .from("tasks")
              .select("*")
              .order("created_at", { ascending: false });
            if (data) tasks.value = data;
            loading.value = false;
          };

          // Timer & Display
          const timeDisplay = computed(() => ({
            time: now.value.format("HH:mm:ss"),
            date: now.value.format("YYYY-MM-DD"),
            day: now.value.format("dddd"),
          }));

          const getTasksByQuadrant = (q) =>
            tasks.value.filter((t) => t.quadrant === q && t.status === "todo");
          const basketTask = computed(() =>
            tasks.value.find((t) => t.status === "in_basket")
          );

          const currentTimerDisplay = computed(() => {
            if (!basketTask.value) return "00:00:00";
            const t = basketTask.value;
            let current = 0;
            if (t.start_time)
              current = now.value.diff(dayjs(t.start_time), "second");
            return formatDuration(
              (t.duration_seconds || 0) + (current > 0 ? current : 0)
            );
          });

          // Stats
          const completedTasks = computed(() =>
            tasks.value.filter((t) => t.status === "done")
          );
          const todayStats = computed(() => {
            const today = completedTasks.value.filter((t) =>
              dayjs(t.completed_at).isSame(dayjs(), "day")
            );
            const duration = today.reduce(
              (acc, t) => acc + (t.duration_seconds || 0),
              0
            );
            return { count: today.length, duration: duration };
          });
          const weekStats = computed(() => {
            const startOfWeek = dayjs().startOf("week");
            const week = completedTasks.value.filter((t) =>
              dayjs(t.completed_at).isAfter(startOfWeek)
            );
            const duration = week.reduce(
              (acc, t) => acc + (t.duration_seconds || 0),
              0
            );
            return { count: week.length, duration: duration };
          });

          // Calendar Logic
          const calendarTitle = computed(() =>
            currentCalendarDate.value.format("YYYYå¹´ MMæœˆ")
          );

          const calendarDays = computed(() => {
            const startOfMonth = currentCalendarDate.value.startOf("month");
            const startOfGrid = startOfMonth.startOf("week");
            const days = [];

            // Generate 42 days (6 weeks) to cover any month grid
            for (let i = 0; i < 42; i++) {
              const date = startOfGrid.add(i, "day");
              const dateStr = date.format("YYYY-MM-DD");
              const hasTask = completedTasks.value.some(
                (t) => dayjs(t.completed_at).format("YYYY-MM-DD") === dateStr
              );

              days.push({
                dateObj: date,
                dateStr: dateStr,
                dayNum: date.date(),
                isCurrentMonth:
                  date.month() === currentCalendarDate.value.month(),
                isToday: date.isSame(dayjs(), "day"),
                isSelected: date.isSame(selectedDate.value, "day"),
                hasTask: hasTask,
              });
            }
            return days;
          });

          const changeMonth = (delta) => {
            currentCalendarDate.value = currentCalendarDate.value.add(
              delta,
              "month"
            );
          };

          const selectDate = (day) => {
            selectedDate.value = day.dateObj;
          };

          const openCalendar = () => {
            selectedDate.value = dayjs(); // Reset select to today when opening
            currentCalendarDate.value = dayjs();
            showCalendar.value = true;
          };

          const selectedDateFormatted = computed(() =>
            selectedDate.value.format("MMæœˆDDæ—¥")
          );

          const selectedDateTasks = computed(() => {
            return completedTasks.value
              .filter((t) =>
                dayjs(t.completed_at).isSame(selectedDate.value, "day")
              )
              .sort(
                (a, b) => new Date(b.completed_at) - new Date(a.completed_at)
              );
          });

          // Helpers
          const formatDuration = (s) => {
            if (!s) return "00:00:00";
            const h = Math.floor(s / 3600),
              m = Math.floor((s % 3600) / 60),
              sec = s % 60;
            return `${p(h)}:${p(m)}:${p(sec)}`;
          };
          const formatHours = (s) => (s / 3600).toFixed(1);
          const p = (n) => n.toString().padStart(2, "0");
          const getQuadrantName = (id) =>
            quadrants.find((q) => q.id === id)?.name;
          const getQuadrantColor = (id) =>
            ({
              1: "bg-red-400",
              2: "bg-blue-400",
              3: "bg-amber-400",
              4: "bg-slate-400",
            }[id]);
          const getQuadrantTextColor = (id) =>
            ({
              1: "text-red-500",
              2: "text-blue-500",
              3: "text-amber-600",
              4: "text-slate-500",
            }[id]);

          // Actions
          const openAddModal = (q) => {
            newTask.value = {
              title: "",
              description: "",
              tags: "",
              quadrant: q,
            };
            showModal.value = true;
          };

          const addTask = async () => {
            if (!newTask.value.title.trim()) return;
            const temp = { ...newTask.value, status: "todo" };
            const optimisticId = Date.now();
            tasks.value.unshift({
              ...temp,
              id: optimisticId,
              created_at: new Date(),
            });
            showModal.value = false;
            const { data } = await client.from("tasks").insert([temp]).select();
            if (data) {
              const idx = tasks.value.findIndex((t) => t.id === optimisticId);
              if (idx !== -1) tasks.value[idx] = data[0];
            }
          };

          const moveToBasket = async (task) => {
            if (basketTask.value)
              return alert("è¯·å…ˆå®Œæˆæˆ–æš‚åœå½“å‰ä¸“æ³¨çš„ä»»åŠ¡ï¼");
            task.status = "in_basket";
            task.start_time = new Date().toISOString();
            await client
              .from("tasks")
              .update({
                status: "in_basket",
                start_time: new Date().toISOString(),
              })
              .eq("id", task.id);
          };

          const pauseTask = async (task) => {
            const session = dayjs().diff(dayjs(task.start_time), "second");
            const newTotal = (task.duration_seconds || 0) + session;
            task.status = "todo";
            task.duration_seconds = newTotal;
            task.start_time = null;
            await client
              .from("tasks")
              .update({
                status: "todo",
                duration_seconds: newTotal,
                start_time: null,
              })
              .eq("id", task.id);
          };

          const completeTask = async (task) => {
            const session = task.start_time
              ? dayjs().diff(dayjs(task.start_time), "second")
              : 0;
            const newTotal = (task.duration_seconds || 0) + session;
            task.status = "done";
            task.duration_seconds = newTotal;
            task.completed_at = new Date().toISOString();
            task.start_time = null;
            await client
              .from("tasks")
              .update({
                status: "done",
                duration_seconds: newTotal,
                completed_at: new Date().toISOString(),
                start_time: null,
              })
              .eq("id", task.id);
          };

          const deleteTask = async (id) => {
            if (!confirm("ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡?")) return;
            tasks.value = tasks.value.filter((t) => t.id !== id);
            await client.from("tasks").delete().eq("id", id);
          };

          return {
            tasks,
            loading,
            showModal,
            showStats,
            showCalendar,
            newTask,
            quadrants,
            basketTask,
            currentTimerDisplay,
            timeDisplay,
            todayStats,
            weekStats,
            calendarTitle,
            calendarDays,
            changeMonth,
            selectDate,
            selectedDateFormatted,
            selectedDateTasks,
            openCalendar,
            getTasksByQuadrant,
            openAddModal,
            getQuadrantName,
            getQuadrantColor,
            getQuadrantTextColor,
            addTask,
            moveToBasket,
            pauseTask,
            completeTask,
            deleteTask,
            formatDuration,
            formatHours,
          };
        },
      }).mount("#app");
    </script>

    <style>
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </body>
</html>
